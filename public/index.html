<!DOCTYPE HTML>
<html>

  <head>
    <meta name="viewport" content="initial-scale=1.0">
    <style>
      html, body {
        height:100%;
        margin: 0;
        padding:0;
      }
      #mapAndBar {
        height:100%;
        width:100%;
      }
      #map, #sideBar {display: inline-block; *display: inline; vertical-align: top} 
      #map {
        height:100%;
        width:65%;
        background-color: #CCC;
        overflow: auto;
      }
      #sideBar {
        height:100%;
        width:35%;
        position: absolute;
      }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
  </head>
  <body>
    <title id="test">TEST</title>
    <div id="filters">
        <select name="States:">
            <option value="CO">CO</select>
        </select>
    </div>
    <div id="mapAndBar">
    <div id="map"></div>
    <div id="sideBar"> TEXT GOES HERE</div>
    <script>
        var home="http://localhost:8080"
        var urlStations=home+"/stations";
        var urlInventory=home+"/inventory";
        var urlObservation=home+"/observation";
        var data = {'states' : 'CO'};
        var map = null;

        function histogram(dataSeries){
            var bins = [];
            dataSeries.forEach(
                function(dataValues){
                    
                });
        };
        function drawPlot(station,element,observations){
            var series = [];
            var title = element+" - for Station:"+station;
            observations.forEach(
                function(observation){
                var values = observation.data;
                var name = observation.element.name;
                var month = observation.month;
                var year = observation.year;
                var data = [];
                var day;
                for(day = 0; day < values.length; day++){
                    data.push([Date.UTC(year, month, day+1), values[day]]);
                }
                series.push({name: name, data: data});
            });
            console.log(series.length);
            var sideBar = document.getElementById("sideBar");
            $('#sideBar').highcharts({
                    chart: {
                           type: 'spline'
                           },
                    title: {
                           text: title
                    },
                    subtitle: {
                        text: 'Irregular time data in Highcharts JS'
                    },
                    xAxis: {
                        type: 'datetime',
                        dateTimeLabelFormats: { // don't display the dummy year
                        month: '%e. %b',
                        year: '%b'
                    },
                    title: {
                    text: 'Date'
                    }
                    },
                    yAxis: {
                    title: {
                    text: 'Snow depth (m)'
                    },
                    min: 0
                    },
                    tooltip: {
                    headerFormat: '<b>{series.name}</b><br>',
                    pointFormat: '{point.x:%e. %b}: {point.y:.2f} m'
                    },
                    plotOptions: {
                    spline: {
                    marker: {
                    enabled: true
                    }
                    }
                    },
                    series: series
                    // Define the data points. All series have a dummy year
                    // of 1970/71 in order to be compared on the same x axis. Not
                    // that in JavaScript, months start at 0 for January, 1 for February etc.
               });
           };

           function showStations(stations){
                stations.forEach(
                    function(station){
                        var marker = new google.maps.Marker({
                            position:{
                                lat:station.latitude,
                                lng:station.longitude},
                            map:map,
                            title:station.id
                    });
                    marker.addListener('click', function() {
                        $.getJSON(urlInventory,
                            {'stations':station.id},function(data){
                          var text = 
                            '<h3>Station Name: '+station.name+'</h3>'+
                            'Station ID: '+station.id +
                            '<br>'+
                            'Available Data: ';
                          data.forEach(function(inventory){
                            inventory.elements.forEach(function(element){
                            var butText = 
                                element.name+
                                '('+element.range.startYear+"-"+
                                element.range.endYear+')';
                            text+=
                                '<br>'+
                                "<button class='showObs' type='button' width=100% name="+element.name+">"+
                                    butText+" </button>";
                            });
                          });

                          var infowindow = new google.maps.InfoWindow({
                              content: text
                          });
                          infowindow.addListener('domready', function(){
                            var buttonList = document.getElementsByClassName('showObs');
                            var i;
                            for(i =0; i < buttonList.length; i++){
                                var button = buttonList[i];
                                button.onclick = function(button,station) {
                                    return function(){
                                  $.getJSON(urlObservation,
                                      {'stations':station.id, 
                                      'elements':button.name},
                                        function(observations){
                                            drawPlot(station,button.name,stationobservations);
                                        });
                                    };
                                }(button,station);
                            };
                          });
                          infowindow.open(map, marker);
                        });
                    });
               });
           };

        function getStations(data){
            $.getJSON(urlStations,data,
              function(data){
                console.log('received: '+data.stations.length);
                showStations(data.stations)
              });
        };

        function initialize(){
            var mapCanvas = document.getElementById('map');
            var mapOptions = {
                center: new google.maps.LatLng(44.5403,-78.5463),
                zoom: 5,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            }
            map = new google.maps.Map(mapCanvas,mapOptions);
            // Get all stations
            getStations({});
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA42xJeCH1tapNwzg3elUgMgc9yVVLFgM0&callback=initialize"></script>
    </div>
 </body>
</html>
